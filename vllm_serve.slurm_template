source /etc/profile
ml zlib/1.2.13 Python/3.11.5-GCCcore-13.2.0
python3 -m pip install --upgrade pip
python3 -m pip install --upgrade transformers
ml vLLM
echo ${SLURMD_NODENAME}

# Determine if model is DeepSeek
EXTRA_ARGS=""
if [[ "$1" == *deepseek* ]]; then
  EXTRA_ARGS="--enable-reasoning --reasoning-parser deepseek_r1"
fi

vllm serve "$1" \
  --port "$2" \
  --tensor-parallel-size $(echo $SLURM_GPUS | awk 'BEGIN{FS=":"}{print $2}') \
  --host ${SLURMD_NODENAME} \
  --device cuda \
  --max-num-seqs 128 \
  --max-num-batched-tokens 131072 \
  --gpu-memory-utilization 0.95 \
  --chat-template ./template.mustache \
  --trust-remote-code \
  $EXTRA_ARGS
